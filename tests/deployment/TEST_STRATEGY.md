# 배포 시스템 테스트 전략 (Deployment System Test Strategy)

> **문서 버전:** 1.0.0
> **작성일:** 2026-01-27
> **마지막 수정:** 2026-01-27
> **적용 범위:** forms-interface 자동 배포 시스템

---

## 목차

1. [개요](#1-개요)
2. [테스트 범위](#2-테스트-범위)
3. [테스트 피라미드](#3-테스트-피라미드)
4. [단위 테스트 전략](#4-단위-테스트-전략)
5. [통합 테스트 전략](#5-통합-테스트-전략)
6. [엣지 케이스 테스트 전략](#6-엣지-케이스-테스트-전략)
7. [보안 테스트 전략](#7-보안-테스트-전략)
8. [성능 테스트 전략](#8-성능-테스트-전략)
9. [테스트 실행 가이드](#9-테스트-실행-가이드)
10. [품질 메트릭 및 성공 기준](#10-품질-메트릭-및-성공-기준)

---

## 1. 개요

### 1.1 시스템 개요

배포 시스템은 Windows(개발 환경)와 Raspberry Pi(배포 환경) 간의 자동화된 배파 워크플로우를 제공합니다.

**주요 구성요소:**
- `windows-deploy.bat`: Windows에서 캐시 버전 증가 및 Git 푸시
- `deploy-and-restart.sh`: Raspberry Pi에서 배포 및 서비스 재시작
- `restart-services.sh`: nginx, n8n 서비스 재시작
- `setup-raspberry-pi.sh`: 초기 설정 스크립트

### 1.2 테스트 목표

1. **기능 정확성:** 모든 배파 단계가 올바르게 실행되는지 확인
2. **안정성:** 다양한 엣지 케이스에서도 시스템이 안정적으로 동작하는지 검증
3. **보안:** 파일 권한, 민감 정보 노출 등 보안 요구사항 준수 확인
4. **성능:** 배포 시간, 자원 사용량이 허용 범위 내인지 확인
5. **자동화:** 반복적인 테스트를 자동화하여 CI/CD 통합 가능성 확인

### 1.3 테스트 원칙

**TRUST 5 프레임워크 기반:**
- **Testable:** 모든 기능이 테스트 가능하도록 설계
- **Readable:** 테스트 코드가 명확하고 이해하기 쉬워야 함
- **Unified:** 일관된 테스트 패턴과 구조 사용
- **Secured:** 보안 테스트 포함
- **Trackable:** 테스트 결과 추적 및 보고

---

## 2. 테스트 범위

### 2.1 대상 시스템

| 스크립트 | 주요 기능 | 테스트 우선순위 |
|--------|----------|--------------|
| `windows-deploy.bat` | 캐시 버전 증가, Git 커밋/푸시 | **High** |
| `deploy-and-restart.sh` | Git pull, 배포, 서비스 재시작 | **Critical** |
| `restart-services.sh` | nginx/n8n 서비스 재시작 | Medium |
| `setup-raspberry-pi.sh` | 초기 설정 | Medium |

### 2.2 테스트 범위 상세

**포함 (In Scope):**
- 배파 스크립트의 개별 함수 로직
- 전체 배파 워크플로우 (Windows → GitHub → Raspberry Pi)
- 에러 복구 및 롤백 메커니즘
- 네트워크 장애 상황
- 보안 검증 (파일 권한, 노출 정보)
- 성능 측정 (배포 시간, 자원 사용)

**제외 (Out of Scope):**
- Cloudflare Tunnel 설정 테스트 (별도 가이드 참조)
- n8n 워크플로우 기능 테스트
- 하드웨어 성능 벤치마킹

---

## 3. 테스트 피라미드

```
        /\
       /  \
      / E2E\          10% (통합 테스트)
     /------\
    /  통합  \        20% (엣지 케이스 + 보안 + 성능)
   /----------\
  /   단위     \      70% (개별 기능 테스트)
 /--------------\
```

### 3.1 테스트 레벨 정의

**단위 테스트 (70%):**
- 개별 함수 로직 테스트
- Mock/Stub을 사용한 격리된 테스트
- 빠른 실행 속도 (초당 수십~수백 개)

**통합 테스트 (20%):**
- 컴포넌트 간 상호작용 테스트
- 엣지 케이스, 에러 복구 시나리오
- 보안, 성능 검증

**E2E 테스트 (10%):**
- 전체 워크플로우 테스트
- 실제 환경 또는 스테이징 환경에서 실행
- 사용자 시나리오 기반

---

## 4. 단위 테스트 전략

### 4.1 Git 충돌 감지 로직

**테스트 항목:**
1. 로컬 변경 사항 감지 (git diff --quiet)
2. stash 생성 및 메시지 포맷
3. git fetch 정상 동작
4. git reset --hard 정상 동작

**예상 결과:**
- 변경 사항이 있을 때만 stash 생성
- stash 메시지에 타임스탬프 포함
- fetch 후 reset으로 병합 충돌 없음

### 4.2 캐시 버전 증가 로직

**테스트 항목:**
1. 현재 버전 파싱 (정규표현식)
2. 패치 버전 증가 (1.0.5 → 1.0.6)
3. index.html 업데이트

**예상 결과:**
- 정확한 버전 파싱
- 패치 번호만 증가
- index.html에 올바른 버전 반영

### 4.3 파일 권한 설정 로직

**테스트 항목:**
1. 디렉토리 권한 755 설정
2. 핵심 파일 읽기 전용 444 설정
3. 소유자 유지 (raspi:raspi)

**예상 결과:**
- 웹 서버가 파일을 읽을 수 있음
- 핵심 파일이 실수로 수정되지 않음

### 4.4 심볼릭 링크 생성 로직

**테스트 항목:**
1. 기존 배포 백업
2. 심볼릭 링크 생성
3. 링크 유효성 검증

**예상 결과:**
- 기존 배포가 타임스탬프와 함께 백업됨
- 링크가 올바른 소스를 가리킴

---

## 5. 통합 테스트 전략

### 5.1 Windows → GitHub → Raspberry Pi 전체 흐름

**테스트 시나리오:**
1. Windows에서 index.html 수정
2. windows-deploy.bat 실행
3. GitHub에서 커밋 확인
4. Raspberry Pi에서 deploy-and-restart.sh 실행
5. 브라우저에서 변경 사항 확인

**예상 결과:**
- 모든 단계가 순차적으로 실행됨
- 버전이 자동으로 증가함
- 브라우저에서 최신 버전이 로드됨

### 5.2 에러 복구 절차

**테스트 시나리오:**
1. 네트워크 연결 실패 상황
2. Git 원격 저장소 접속 불가
3. 디스크 공간 부족
4. 웹 서버 이미 실행 중

**예상 결과:**
- 명확한 에러 메시지 출력
- 적절한 롤백 수행
- 시스템 상태 유지

### 5.3 롤백 메커니즘

**테스트 시나리오:**
1. 배포 실패 시 백업 복원
2. 이전 버전으로 롤백

**예상 결과:**
- 백업이 정상적으로 복원됨
- 이전 버전이 정상적으로 실행됨

---

## 6. 엣지 케이스 테스트 전략

### 6.1 네트워크 연결 실패

**테스트 항목:**
1. GitHub 연결 타임아웃
2. 인터넷 연결 끊김
3. DNS 해결 실패

**예상 결과:**
- 적절한 타임아웃 처리
- 사용자에게 명확한 에러 메시지
- 재시도 메커니즘 (선택사항)

### 6.2 디스크 공간 부족

**테스트 항목:**
1. /var/www/html 공간 부족
2. Git 저장소 공간 부족
3. 백업 디렉토리 공간 부족

**예상 결과:**
- 배포 전 디스크 공간 확인
- 공간 부족 시 배포 중단
- 사용자에게 디스크 정리 안내

### 6.3 웹 서버 이미 실행 중

**테스트 항목:**
1. nginx 포트 80 이미 사용 중
2. Apache와 nginx 충돌
3. 기존 프로세스 종료 실패

**예상 결과:**
- 실행 중인 서비스 감지
- Graceful restart (재시작)
- 또는 사용자에게 수동 조치 안내

### 6.4 Git 원격 저장소 접속 불가

**테스트 항목:**
1. GitHub API 다운
2. SSH 키 인증 실패
3. 원격 브랜치 삭제됨

**예상 결과:**
- 명확한 에러 메시지
- 로컬 상태 유지
- 재시도 가능성 안내

---

## 7. 보안 테스트 전략

### 7.1 파일 권한 검증

**테스트 항목:**
1. 웹 서버가 읽기만 가능한지 확인
2. 핵심 파일이 쓰기 금지되어 있는지 확인
3. 소유자가 올바른지 확인

**예상 결과:**
- index.html, script.js, style.css: 444 (읽기 전용)
- 디렉토리: 755 (읽기/실행)
- 소유자: raspi:raspi

### 7.2 민감 정보 노출 확인

**테스트 항목:**
1. Git 로그에 비밀번호 노출 여부
2. 스크립트 내 하드코딩된 비밀번호
3. 로그 파일에 민감 정보 포함 여부

**예상 결과:**
- 민감 정보가 환경변수로 분리되어 있음
- 로그에 비밀번호가 포함되지 않음
- .gitignore에 민감 파일 포함됨

### 7.3 무단 접근 방지 검증

**테스트 항목:**
1. SSH 키 권한 확인 (600)
2. 스크립트 실행 권한 확인
3. 웹 서버를 통한 디렉토리 리스트 차단

**예상 결과:**
- SSH 키가 적절한 권한을 가짐
- root 권한이 필요한 작업만 sudo로 실행
- 웹 서버가 .git 디렉토리에 접근할 수 없음

---

## 8. 성능 테스트 전략

### 8.1 배포 소요 시간 측정

**테스트 항목:**
1. windows-deploy.bat 실행 시간
2. deploy-and-restart.sh 실행 시간
3. 전체 배파 워크플로우 시간

**성능 기준:**
- windows-deploy.bat: < 30초
- deploy-and-restart.sh: < 60초
- 전체 워크플로우: < 2분

### 8.2 대용량 파일 처리 테스트

**테스트 항목:**
1. 100MB 이상의 파일이 포함된 경우
2. 수천 개의 파일이 포함된 경우

**예상 결과:**
- 배포 시간이 선형적으로 증가
- 메모리 사용량이 급격히 증가하지 않음

### 8.3 자동 업데이트 타이머 부하 테스트

**테스트 항목:**
1. systemd 타이머가 1시간마다 실행될 때
2. 시스템 부하가 높은 상태에서 실행

**예상 결과:**
- 시스템 부하에 영향을 받지 않음
- 타이머가 겹치지 않음
- 실패 시 재시도 로직이 동작함

---

## 9. 테스트 실행 가이드

### 9.1 사전 준비사항

**Windows 환경:**
- Git 설치
- PowerShell 5.0 이상
- GitHub 인증 설정 (SSH 또는 PAT)

**Raspberry Pi 환경:**
- Raspberry Pi OS 최신 버전
- nginx 또는 apache2 설치
- Git 설치
- SSH 접속 가능

### 9.2 테스트 실행 순서

1. **단위 테스트 실행**
   ```bash
   # Raspberry Pi에서
   cd tests/deployment
   ./run-unit-tests.sh
   ```

2. **통합 테스트 실행**
   ```bash
   # Raspberry Pi에서
   ./run-integration-tests.sh
   ```

3. **엣지 케이스 테스트 실행**
   ```bash
   # Raspberry Pi에서
   ./run-edge-case-tests.sh
   ```

4. **보안 테스트 실행**
   ```bash
   # Raspberry Pi에서
   ./run-security-tests.sh
   ```

5. **성능 테스트 실행**
   ```bash
   # Raspberry Pi에서
   ./run-performance-tests.sh
   ```

### 9.3 테스트 결과 확인

**결과 파일 위치:**
- 단위 테스트: `tests/deployment/results/unit-test-results.log`
- 통합 테스트: `tests/deployment/results/integration-test-results.log`
- 엣지 케이스: `tests/deployment/results/edge-case-results.log`
- 보안 테스트: `tests/deployment/results/security-test-results.log`
- 성능 테스트: `tests/deployment/results/performance-test-results.log`

### 9.4 CI/CD 통합

**GitHub Actions 예시:**
```yaml
name: Deployment Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run deployment tests
        run: |
          chmod +x tests/deployment/run-all-tests.sh
          ./tests/deployment/run-all-tests.sh
```

---

## 10. 품질 메트릭 및 성공 기준

### 10.1 테스트 커버리지

| 테스트 유형 | 최소 커버리지 | 목표 커버리지 |
|-----------|-------------|-------------|
| 단위 테스트 | 80% | 90% |
| 통합 테스트 | 70% | 85% |
| 엣지 케이스 | 60% | 75% |
| 보안 테스트 | 100% | 100% |
| 성능 테스트 | N/A | N/A |

### 10.2 성공 기준

**단위 테스트:**
- 모든 테스트 케이스 통과
- 코드 커버리지 80% 이상
- 플레이크(Flake)률 1% 미만

**통합 테스트:**
- 전체 워크플로우 성공적으로 완료
- 모든 검증 단계 통과
- 롤백 메커니즘 정상 동작

**엣지 케이스 테스트:**
- 모든 엣지 케이스에서 적절한 에러 처리
- 시스템 크래시 없음
- 명확한 에러 메시지 제공

**보안 테스트:**
- 모든 보안 검증 통과
- 민감 정보 노출 없음
- 파일 권한 올바르게 설정됨

**성능 테스트:**
- 모든 성능 기준 충족
- 메모리 누수 없음
- 배포 시간 허용 범위 내

### 10.3 테스트 보고서 템플릿

**주요 섹션:**
1. 실행 요약 (테스트 수, 통과/실패, 커버리지)
2. 실패한 테스트 상세 (로그, 스크린샷)
3. 성능 메트릭 (시간, 자원 사용)
4. 보안 검증 결과
5. 개선 권장사항

---

## 문서 관리

**버전 관리:**
- 이 문서는 Git으로 버전 관리됩니다
- 주요 변경 시 버전 번호를 업데이트합니다

**검토 주기:**
- 매분기 또는 주요 배포 시스템 변경 시 검토

**유지 관리:**
- 테스트 전략은 지속적으로 업데이트됩니다
- 새로운 테스트 요구사항이 발생할 때마다 추가

---

## 참고 자료

- [Deployment Guide](../DEPLOYMENT_GUIDE.md)
- [pytest Documentation](https://docs.pytest.org/)
- [Bash Unit Testing](https://github.com/sstephenson/bats)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)

